<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulación de Modelos Farmacocinéticos y Fluidos</title>
    <!-- Carga de Tailwind CSS para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de color y fuente para Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1c7ed6',
                        'light-gray': '#f4f7f9',
                        'dark-text': '#1f2937',
                        'model-1': '#38bdf8', /* Azul claro */
                        'model-2': '#8b5cf6', /* Violeta */
                        'model-3': '#ef4444', /* Rojo */
                        'neon-pink': '#FF3366',
                        'neon-blue': '#33FFFF',
                        'fluid-icf': '#22c55e', /* Verde esmeralda para ICF */
                        'fluid-ecf': '#f59e0b', /* Ámbar para ECF */
                        'fluid-plasma': '#ef4444', /* Rojo para Plasma */
                        'fluid-interstitial': '#3b82f6', /* Azul para Intersticial */
                    }
                }
            }
        }
    </script>
    <!-- Carga de Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* Estilo para el contenedor del gráfico principal */
        .chart-container {
            height: 400px;
            width: 100%;
        }
        /* Estilo para los botones de modelo */
        .model-button {
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .model-button.active-1 { background-color: var(--color-model-1); color: white; transform: translateY(-2px); border-color: #0c619b; }
        .model-button.active-2 { background-color: var(--color-model-2); color: white; transform: translateY(-2px); border-color: #550fcc; }
        .model-button.active-3 { background-color: var(--color-model-3); color: white; transform: translateY(-2px); border-color: #c50c0c; }
        
        /* Estilo para el contenedor del diagrama SVG */
        .diagram-box { border: 2px dashed #ccc; background-color: #ffffff; }

        /* Clase para los puntos de flujo. */
        .flow-dot {
            r: 5;
            transition: all 0.5s ease-in-out; /* Transición suave para el movimiento y color */
            visibility: hidden;
            pointer-events: none;
            stroke-dasharray: none;
        }

        .flow-dot-visible {
            visibility: visible;
        }

        .dot-pulse { animation: pulse 1s infinite; }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* === Estilos para el Navegador === */
        .nav-link {
            transition: all 0.2s;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .nav-link.active {
            background-color: #1c7ed6; /* primary-blue */
            color: white;
            box-shadow: 0 4px 10px rgba(28, 126, 214, 0.3);
        }
        .nav-link:not(.active):hover {
            background-color: #e0f2fe; /* blue-50 */
            color: #1c7ed6;
        }

        /* === Estilos para el Footer Neon y Máquina de Escribir === */
        .neon-text {
            color: white;
            text-shadow: 0 0 7px #fff, 0 0 10px #fff, 0 0 21px #FF3366, 0 0 42px #FF3366, 0 0 82px #FF3366, 0 0 92px #FF3366, 0 0 102px #FF3366, 0 0 151px #FF3366;
            font-family: monospace;
            white-space: nowrap;
            overflow: hidden;
        }
        .typing-cursor {
            display: inline-block;
            width: 0.5em; 
            height: 1.2em;
            background-color: #FF3366; 
            margin-left: 5px;
            animation: blink-cursor 0.75s step-end infinite;
            vertical-align: middle;
        }
        @keyframes blink-cursor {
            from, to { opacity: 0; }
            50% { opacity: 1; }
        }
        .neon-button {
            box-shadow: 0 0 5px #33FFFF, 0 0 15px #33FFFF, 0 0 30px #33FFFF, 0 0 45px #33FFFF;
            transition: all 0.3s ease-in-out;
        }
        .neon-button:hover {
            background-color: #33FFFF;
            color: #1f2937;
            box-shadow: 0 0 5px #FF3366, 0 0 15px #FF3366, 0 0 30px #FF3366, 0 0 45px #FF3366;
        }
        
        /* Estilo para las opciones del quiz */
        .quiz-option {
            transition: all 0.2s;
            cursor: pointer;
        }
        .quiz-option:hover:not(.correct):not(.incorrect) {
            background-color: #e0f2fe; /* Light blue on hover */
        }
        .quiz-option.correct {
            background-color: #d1fae5; /* Green for correct */
            border-color: #10b981;
            font-weight: bold;
        }
        .quiz-option.incorrect {
            background-color: #fee2e2; /* Red for incorrect */
            border-color: #ef4444;
        }
    </style>
</head>
<body class="bg-light-gray font-sans text-dark-text p-4 md:p-8 flex flex-col min-h-screen" style="--color-model-1: #38bdf8; --color-model-2: #8b5cf6; --color-model-3: #ef4444;">

    <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-extrabold text-primary-blue mb-2">Liquidos corporales | Composicion</h1>
        <p class="text-lg text-gray-600 max-w-6xl mx-auto">Explora la cinética de los liquidos en el organismo y sus diferentes composiciones de forma interactiva y única.</p>
    </header>

    <!-- Navegador de Vistas -->
    <div class="flex justify-center space-x-4 mb-8 max-w-6xl mx-auto w-full">
        <button id="nav-compartments" onclick="changeView('compartments')" 
                class="nav-link active">
            SISTEMAS DE COMPARTIMENTOS
        </button>
        <button id="nav-fluids" onclick="changeView('fluids')" 
                class="nav-link">
            LÍQUIDOS CORPORALES
        </button>
    </div>

    <!-- Contenido Principal -->
    <main class="max-w-6xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-2xl border border-gray-200 mb-8 flex-grow w-full">
        
        <!-- === VISTA 1: SISTEMAS DE COMPARTIMENTOS === -->
        <div id="view-compartments" class="view-content">
            
            <h2 class="text-2xl font-bold mb-6 text-primary-blue">Modelos Farmacocinéticos</h2>

            <!-- Controles de Alternancia del Modelo -->
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mb-8">
                <button id="btn-model-1" onclick="updateChart(1)" class="model-button bg-gray-100 text-dark-text font-bold py-3 px-6 rounded-lg border-2 border-gray-300 hover:bg-model-1/70 hover:text-white">
                    Modelo de 1 Compartimento
                </button>
                <button id="btn-model-2" onclick="updateChart(2)" class="model-button bg-gray-100 text-dark-text font-bold py-3 px-6 rounded-lg border-2 border-gray-300 hover:bg-model-2/70 hover:text-white">
                    Modelo de 2 Compartimentos
                </button>
                <button id="btn-model-3" onclick="updateChart(3)" class="model-button bg-gray-100 text-dark-text font-bold py-3 px-6 rounded-lg border-2 border-gray-300 hover:bg-model-3/70 hover:text-white">
                    Modelo de 3 Compartimentos
                </button>
            </div>

            <!-- Gráfico Principal y Diagrama (Estructura en Grid) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                
                <!-- 1. Diagrama Dinámico -->
                <div id="modelDiagramContainer" class="p-4 rounded-xl bg-light-gray flex items-center justify-center h-[400px] border border-gray-300 order-1 lg:order-1">
                    <p class="text-gray-500">Mueva el cursor sobre el gráfico de la derecha para ver la dinámica.</p>
                </div>

                <!-- 2. Gráfico Principal (Chart) -->
                <div class="chart-container border p-4 rounded-xl bg-white order-2 lg:order-2">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <!-- Descripción Dinámica del Modelo -->
            <div id="modelDescription" class="mt-8 p-4 rounded-xl text-gray-700 border-l-4 border-primary-blue bg-blue-50">
                <!-- El contenido se inyecta aquí mediante JavaScript -->
            </div>

            <!-- Sección de Quizz Interactiva -->
            <div class="mt-12 p-6 md:p-8 rounded-xl shadow-xl border border-primary-blue/30 bg-blue-50">
                <h3 class="text-2xl font-bold mb-6 text-primary-blue">🧠 Pregunta Tipo Parcial: Conceptos de Sistemas</h3>
                
                <div id="quiz-question" class="text-lg font-medium mb-4 text-dark-text">
                    En un modelo fisiológico de al menos 3 compartimentos, ¿cuál de las siguientes afirmaciones sobre la organización del sistema es **correcta**?
                </div>

                <div id="quiz-options" class="space-y-3">
                    <div class="quiz-option p-4 border-2 border-gray-200 rounded-lg bg-white" data-answer="A" onclick="checkAnswer('A')">
                        <span class="font-bold mr-2">A.</span> La dinámica de flujo es siempre constante e independiente del estado de equilibrio.
                    </div>
                    <div class="quiz-option p-4 border-2 border-gray-200 rounded-lg bg-white" data-answer="B" onclick="checkAnswer('B')">
                        <span class="font-bold mr-2">B.</span> La funcionalidad integral del sistema global está organizada, generalmente, de manera jerárquica.
                    </div>
                    <div class="quiz-option p-4 border-2 border-gray-200 rounded-lg bg-white" data-answer="C" onclick="checkAnswer('C')">
                        <span class="font-bold mr-2">C.</span> El tiempo de vida media del fármaco es idéntico en todos los compartimentos.
                    </div>
                    <div class="quiz-option p-4 border-2 border-gray-200 rounded-lg bg-white" data-answer="D" onclick="checkAnswer('D')">
                        <span class="font-bold mr-2">D.</span> El compartimento periférico (C2) siempre tiene la concentración máxima inmediatamente después de la dosis IV.
                    </div>
                </div>

                <div id="quiz-feedback" class="mt-6 p-4 rounded-lg hidden"></div>
            </div>
        </div>

        <!-- === VISTA 2: LÍQUIDOS CORPORALES === -->
        <div id="view-fluids" class="view-content hidden">
            <h2 class="text-2xl font-bold mb-6 text-primary-blue">Volumen de Líquidos Corporales Totales (LCT)</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8 items-center">
                <!-- Control de Peso/Agua -->
                <div class="p-6 bg-blue-50 rounded-xl border-l-4 border-fluid-ecf">
                    <h3 class="text-xl font-semibold mb-3 text-dark-text">Parámetros de Entrada</h3>
                    
                    <label for="weight-input" class="block text-gray-700 font-medium mb-2">Peso Corporal (kg):</label>
                    <input type="number" id="weight-input" value="70" min="10" max="200" step="5" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue mb-4">

                    <label for="fluid-percent-slider" class="block text-gray-700 font-medium mb-2">
                        Porcentaje de Agua Corporal Total (% LCT): 
                        <span id="fluid-percent-value" class="font-bold text-fluid-ecf">60</span>%
                    </label>
                    <input type="range" id="fluid-percent-slider" value="60" min="40" max="70" step="1" 
                           class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-lg">
                    
                    <div class="mt-4 text-lg font-bold">
                        Líquido Corporal Total (LCT): <span id="total-fluid-liters" class="text-primary-blue">42.0</span> Litros
                    </div>
                </div>

                <!-- Resumen de Litros -->
                <div class="p-6 bg-green-50 rounded-xl border-l-4 border-fluid-icf">
                    <h3 class="text-xl font-semibold mb-3 text-dark-text">Distribución del LCT (Litros)</h3>
                    <div class="space-y-2">
                        <p class="text-lg">
                            <span class="font-bold text-fluid-icf">Líquido Intracelular (LIC):</span> 
                            <span id="icf-liters" class="float-right font-mono">28.0 L</span>
                        </p>
                        <hr class="border-gray-300">
                        <p class="text-lg">
                            <span class="font-bold text-fluid-ecf">Líquido Extracelular (LEC):</span> 
                            <span id="ecf-liters" class="float-right font-mono">14.0 L</span>
                        </p>
                        <div class="pl-4 pt-2 border-t border-gray-100">
                            <p class="text-sm text-gray-600">
                                Plasma: <span id="plasma-liters" class="float-right font-mono">3.5 L</span>
                            </p>
                            <p class="text-sm text-gray-600">
                                Intersticial: <span id="interstitial-liters" class="float-right font-mono">10.5 L</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Espacio para gráficas hechas a mano -->
            <div class="mt-8 p-6 rounded-xl bg-gray-100 border-2 border-gray-300 text-center text-lg text-gray-600 font-semibold">
                Espacio reservado para las gráficas de distribución de líquidos (LIC/LEC y composición del LEC).
                <a href="https://docs.google.com/spreadsheets/d/1lZ_LrIvyKVnbiGP3IhEJflF-p5dCEe3Sx9RsEXmG-b8/edit?usp=sharing" target="_blank" 
               class="neon-button inline-block px-8 py-3 rounded-full text-lg font-bold tracking-wider 
                      text-neon-blue bg-dark-text border-2 border-neon-blue uppercase">Haz click aqui para analizarlas
                </a>
            </div>


            <div class="mt-6 p-4 rounded-xl text-gray-700 border-l-4 border-fluid-ecf bg-yellow-50">
                <p>El porcentaje de agua corporal total varía típicamente: lactantes (~75%), hombres adultos (~60%), mujeres adultas (~50-55%), y ancianos (~45%).</p>
            </div>
        </div>

    </main>

    <!-- FOOTER CON ANIMACIÓN TIPO MÁQUINA DE ESCRIBIR -->
    <footer class="bg-dark-text p-6 md:p-8 text-center mt-auto">
        <div class="max-w-6xl mx-auto">
            <div class="h-8 mb-4 flex items-center justify-center">
                <span id="typing-text" class="neon-text text-xl"></span>
                <span id="typing-cursor" class="typing-cursor"></span>
            </div>
            
            <a href="https://www.instagram.com/gesprache_vzla" target="_blank" 
               class="neon-button inline-block px-8 py-3 rounded-full text-lg font-bold tracking-wider 
                      text-neon-blue bg-dark-text border-2 border-neon-blue uppercase">
                @gesprache_vzla
            </a>
        </div>
    </footer>

    <script>
        // === Variables Globales (Compartments) ===
        let myChart; // Chart.js instance for Pharmacokinetics
        let currentModelNumber = 3; // Inicializado en 3 para el último contexto
        let flowSequenceTimeout; 
        let isAnimating = false; 

        // === Variables Globales (Fluids) ===
        let currentView = 'compartments';

        // Función auxiliar para obtener un color más oscuro (accent)
        const getAccentColor = (hex) => {
            // Convierte HEX a HSL
            let r = parseInt(hex.substring(1, 3), 16) / 255;
            let g = parseInt(hex.substring(3, 5), 16) / 255;
            let b = parseInt(hex.substring(5, 7), 16) / 255;
            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max === min) { h = s = 0; }
            else {
                let d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            // Reduce la luminosidad (L) en un 20% para el acento
            const newL = Math.max(0, l - 0.2); 
            
            // Convierte HSL de vuelta a RGB
            let hue2rgb = (p, q, t) => {
                if(t < 0) t += 1;
                if(t > 1) t -= 1;
                if(t < 1/6) return p + (q - p) * 6 * t;
                if(t < 1/2) return q;
                if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                return p;
            };

            let q = newL < 0.5 ? newL * (1 + s) : newL + s - newL * s;
            let p = 2 * newL - q;
            let R = hue2rgb(p, q, h + 1/3);
            let G = hue2rgb(p, q, h);
            let B = hue2rgb(p, q, h - 1/3);

            // Convierte RGB a HEX
            const toHex = (c) => {
                const hex = Math.round(c * 255).toString(16);
                return hex.length === 1 ? "0" + hex : hex;
            };

            return "#" + toHex(R) + toHex(G) + toHex(B);
        };

        // --- Constantes para los Modelos y sus colores acentuados ---
        const D0 = 100; 
        const MAX_TIME = 30;
        const TIME_POINTS = 1000; 
        
        // --- Constantes para Modelo 1 ---
        const C0_1 = D0 / 10;
        const Kel = 0.1;
        const model1Function = (t) => C0_1 * Math.exp(-Kel * t);
        const model1Data = Array.from({ length: TIME_POINTS + 1 }, (_, i) => ({ x: (i / TIME_POINTS) * MAX_TIME, y: model1Function((i / TIME_POINTS) * MAX_TIME) }));

        // --- Constantes para Modelo 2 ---
        const A_2 = 50;
        const B_2 = 20;
        const Alpha_2 = 3.0;
        const Beta_2 = 0.3;
        const model2Function = (t) => (A_2 * Math.exp(-Alpha_2 * t)) + (B_2 * Math.exp(-Beta_2 * t));
        const model2Data = Array.from({ length: TIME_POINTS + 1 }, (_, i) => ({ x: (i / TIME_POINTS) * MAX_TIME, y: model2Function((i / TIME_POINTS) * MAX_TIME) }));
        
        // --- Constantes para Modelo 3 ---
        const A_3 = 60;
        const B_3 = 25;
        const C_3 = 15;
        const Alpha_3 = 5.0;
        const Beta_3 = 1.5;
        const Gamma_3 = 0.2;
        const model3Function = (t) => (A_3 * Math.exp(-Alpha_3 * t)) + (B_2 * Math.exp(-Beta_3 * t)) + (C_3 * Math.exp(-Gamma_3 * t));
        const model3Data = Array.from({ length: TIME_POINTS + 1 }, (_, i) => ({ x: (i / TIME_POINTS) * MAX_TIME, y: model3Function((i / TIME_POINTS) * MAX_TIME) }));

        // === Estructuras de Datos de los Modelos ===
        const models = {
            1: {
                data: model1Data,
                mainFunction: model1Function,
                label: '1 Compartimento (Eliminación Simple)',
                color: '#38bdf8', // Azul claro
                accentColor: getAccentColor('#38bdf8'), // Azul más oscuro
                description: '<h3 class="text-xl font-bold mb-2 text-model-1">Modelo de 1 Compartimento</h3>' + 
                             '<p>Todo el organismo se considera una sola unidad (Compartimento Central). La sustancia se distribuye <strong>instantáneamente</strong> y se elimina con una única constante de velocidad ($$K_e$$).</p>' +
                             '<p><strong>Curva:</strong> Muestra una sola fase de caída (fase beta), representada por una sola función exponencial.</p>'
            },
            2: {
                data: model2Data,
                mainFunction: model2Function,
                label: '2 Compartimentos (Distribución Rápida y Eliminación Lenta)',
                color: '#8b5cf6', // Violeta
                accentColor: getAccentColor('#8b5cf6'), // Violeta más oscuro
                description: '<h3 class="text-xl font-bold mb-2 text-model-2">Modelo de 2 Compartimentos</h3>' +
                             '<p>El cuerpo se divide en el <strong>Compartimento Central (C1)</strong> (sangre, órganos bien perfundidos) y el <strong>Compartimento Periférico (C2)</strong> (tejidos menos irrigados, como el músculo).</p>' +
                             '<p><strong>Curva:</strong> Muestra dos fases: <strong>Fase Alfa</strong> (distribución al C2) y <strong>Fase Beta</strong> (eliminación del C1).</p>'
            },
            3: {
                data: model3Data,
                mainFunction: model3Function,
                label: '3 Compartimentos (Múltiples Fases de Distribución)',
                color: '#ef4444', // Rojo
                accentColor: getAccentColor('#ef4444'), // Rojo más oscuro
                description: '<h3 class="text-xl font-bold mb-2 text-model-3">Modelo de 3 Compartimentos</h3>' +
                             '<p>Añade un tercer compartimento de <strong>muy lenta perfusión (C3)</strong>, como la grasa o los huesos, donde la sustancia se acumula lentamente. El C1 sigue siendo el de entrada y salida.</p>' +
                             '<p><strong>Curva:</strong> Muestra tres fases: <strong>Alfa, Beta y Gamma</strong>, reflejando el equilibrio secuencial con C2 y C3.</p>'
            }
        };

        // === Funciones de Soporte para la Concentración (Mantenidas) ===
        function calculateCompartmentAmounts(modelNumber, t) {
            let C1 = 0, C2 = 0, C3 = 0;
            const maxDisplayAmount = 100;
            const totalAmount = 1000;

            const C1_conc = models[modelNumber].mainFunction(t);
            C1 = C1_conc * 2.5;

            if (modelNumber === 1) {
                // C1 ya está calculado
            } else if (modelNumber === 2) {
                // Simplificación para visualización
                C2 = totalAmount * 0.4 * (Math.exp(-Beta_2 * t) - Math.exp(-Alpha_2 * t));
                C2 = Math.max(0, C2 * 0.5 + 5);
            } else if (modelNumber === 3) {
                // Simplificación para visualización
                C2 = totalAmount * 0.6 * (Math.exp(-Beta_3 * t) - Math.exp(-Alpha_3 * t));
                C2 = Math.max(0, C2 * 0.5 + 5);
                C3 = totalAmount * 0.4 * (Math.exp(-Gamma_3 * t) - Math.exp(-Beta_3 * t));
                C3 = Math.max(0, C3 * 0.3 + 2);
            }
            
            return {
                C1_conc: C1_conc, // Devolvemos la concentración real para el control de flujo
                C1: Math.min(100, (C1 / maxDisplayAmount) * 100),
                C2: Math.min(100, (C2 / maxDisplayAmount) * 100),
                C3: Math.min(100, (C3 / maxDisplayAmount) * 100),
            };
        }
        
        const hexToHsl = (hex) => {
            let r = parseInt(hex.substring(1, 3), 16) / 255;
            let g = parseInt(hex.substring(3, 5), 16) / 255;
            let b = parseInt(hex.substring(5, 7), 16) / 255;
            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max === min) { h = s = 0; }
            else {
                let d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [Math.round(h * 360), Math.round(s * 100), Math.round(l * 100)];
        };


        function updateDiagramFill(amounts, color) {
            const [h, s] = hexToHsl(color);
            
            const updateRectFill = (id, amountPercent) => {
                const rect = document.getElementById(id);
                if (rect) {
                    // La claridad (lightness) se reduce a medida que aumenta la concentración
                    const lightness = 95 - (amountPercent * 0.45); 
                    rect.style.fill = `hsl(${h}, ${s}%, ${lightness}%)`;
                    // El borde se mantiene visible según la concentración
                    rect.style.strokeWidth = amountPercent > 5 ? 4 : 2; 
                }
            };

            updateRectFill('comp-1', amounts.C1);
            updateRectFill('comp-2', amounts.C2);
            updateRectFill('comp-3', amounts.C3);
        }

        /**
         * Aplica el color acentuado a los compartimentos de origen y destino del flujo.
         * @param {string[]} targetsIds IDs de los compartimentos (ej. ['comp-1', 'comp-2']).
         * @param {string[]} pathsIds IDs de los paths (ej. ['path-12']).
         * @param {string} defaultColor Color principal del modelo.
         * @param {string} accentColor Color acentuado para el flujo.
         */
        function highlightCompartments(targetsIds, pathsIds, defaultColor, accentColor) {
            
            // 1. Resetear todos los bordes y paths a su color normal.
            document.querySelectorAll('[id^="comp-"]').forEach(rect => {
                rect.style.stroke = defaultColor;
                rect.style.strokeWidth = '4'; 
            });
            document.querySelectorAll('[id^="path-"]').forEach(path => {
                path.style.stroke = defaultColor; 
            });
            // Resetear el color de las flechas (polygon de marker-end)
            document.querySelectorAll('.marker-fill').forEach(polygon => {
                polygon.setAttribute('fill', defaultColor);
            });

            // 2. Aplicar el color acentuado a los compartimentos activos
            targetsIds.forEach(id => {
                const rect = document.getElementById(id);
                if (rect) {
                    rect.style.stroke = accentColor;
                    rect.style.strokeWidth = '6'; // Hacer el borde más grueso para destacar
                }
            });

            // 3. Aplicar el color acentuado al path activo
            pathsIds.forEach(id => {
                const path = document.getElementById(id);
                if (path) {
                    path.style.stroke = accentColor;
                    // También actualizar el color de la punta de flecha si existe un marcador
                    const markerId = path.getAttribute('marker-end')?.match(/url\(#(.*)\)/)?.[1] || 
                                     path.getAttribute('marker-start')?.match(/url\(#(.*)\)/)?.[1];
                    if (markerId) {
                        const marker = document.getElementById(markerId);
                        if (marker) {
                            marker.querySelector('.marker-fill').setAttribute('fill', accentColor);
                        }
                    }
                }
            });
        }


        // Función para restaurar los bordes de los compartimentos a su color normal
        function resetCompartmentBorders(defaultColor) {
            document.querySelectorAll('[id^="comp-"]').forEach(rect => {
                rect.style.stroke = defaultColor;
                rect.style.strokeWidth = '4';
            });
            document.querySelectorAll('[id^="path-"]').forEach(path => {
                path.style.stroke = defaultColor;
            });
            document.querySelectorAll('.marker-fill').forEach(polygon => {
                polygon.setAttribute('fill', defaultColor);
            });
        }


        // === Lógica de Animación Secuencial de Flujo ===
        
        // Define las secuencias de flujo disponibles para cada modelo
        const flowSequences = {
            1: [
                { id: 'flow-dot-IV', pathId: 'path-IV', flowType: 'IV_C1', duration: 400, targets: ['comp-1'], paths: ['path-IV'] }, 
                { id: 'flow-dot-E', pathId: 'path-E', flowType: 'C1_E', duration: 600, targets: ['comp-1'], paths: ['path-E'] }   
            ],
            2: [
                { id: 'flow-dot-IV', pathId: 'path-IV', flowType: 'IV_C1', duration: 300, targets: ['comp-1'], paths: ['path-IV'] }, 
                { id: 'flow-dot-12', pathId: 'path-12', flowType: 'C1_C2', duration: 500, targets: ['comp-1', 'comp-2'], paths: ['path-12'] }, 
                { id: 'flow-dot-21', pathId: 'path-21', flowType: 'C2_C1', duration: 500, targets: ['comp-1', 'comp-2'], paths: ['path-21'] }, 
                { id: 'flow-dot-E', pathId: 'path-E', flowType: 'C1_E', duration: 600, targets: ['comp-1'], paths: ['path-E'] }   
            ],
            3: [
                /* RUTA RÁPIDA (C2) - Baja latencia, simula un tránsito más rápido */
                { id: 'flow-dot-IV', pathId: 'path-IV', flowType: 'IV_C1', duration: 300, targets: ['comp-1'], paths: ['path-IV'] }, 
                { id: 'flow-dot-12', pathId: 'path-12', flowType: 'C1_C2', duration: 1500, targets: ['comp-1', 'comp-2'], paths: ['path-12'] }, // Distribución Rápida
                { id: 'flow-dot-21', pathId: 'path-21', flowType: 'C2_C1', duration: 1500, targets: ['comp-1', 'comp-2'], paths: ['path-21'] }, // Redifusión Rápida
                
                /* RUTA LENTA (C3) - Alta latencia, simula un tránsito más lento */
                { id: 'flow-dot-13', pathId: 'path-13', flowType: 'C1_C3', duration: 4500, targets: ['comp-1', 'comp-3'], paths: ['path-13'] }, // Distribución Lenta
                { id: 'flow-dot-31', pathId: 'path-31', flowType: 'C3_C1', duration: 4500, targets: ['comp-1', 'comp-3'], paths: ['path-31'] }, // Redifusión Lenta
                
                /* SALIDA (Eliminación) */
                { id: 'flow-dot-E', pathId: 'path-E', flowType: 'C1_E', duration: 500, targets: ['comp-1'], paths: ['path-E'] }   
            ]
        };

        
        function moveDotAlongPath(dotId, pathId, targets, paths, duration, defaultColor, accentColor, onComplete) {
            const dot = document.getElementById(dotId);
            const path = document.getElementById(pathId);
            
            if (!dot || !path) {
                if(onComplete) onComplete();
                return;
            }

            // 1. Aplicar resaltado de compartimentos y path con el color acentuado
            highlightCompartments(targets, paths, defaultColor, accentColor);

            const pathLength = path.getTotalLength();
            if (pathLength === 0) {
                if(onComplete) onComplete();
                return;
            }

            // 2. Establecer color del punto
            dot.setAttribute('fill', accentColor);
            dot.setAttribute('stroke', accentColor);
            dot.classList.remove('dot-pulse'); 

            // 3. Resetear el punto a su posición inicial
            const initialPoint = path.getPointAtLength(0);
            dot.setAttribute('cx', initialPoint.x);
            dot.setAttribute('cy', initialPoint.y);
            
            // 4. Establecer la duración de la transición CSS
            dot.style.transitionDuration = `${duration}ms`;
            
            // 5. Hacer visible y comenzar la animación de movimiento al final del path
            dot.classList.add('flow-dot-visible');
            
            setTimeout(() => {
                const endPoint = path.getPointAtLength(pathLength);
                dot.setAttribute('cx', endPoint.x);
                dot.setAttribute('cy', endPoint.y);
            }, 10); 

            // 6. Ejecutar el callback después de que la transición haya terminado
            flowSequenceTimeout = setTimeout(() => {
                // Asegurar la posición final
                const endPoint = path.getPointAtLength(pathLength);
                dot.setAttribute('cx', endPoint.x); 
                dot.setAttribute('cy', endPoint.y);

                dot.classList.add('dot-pulse'); // Pulso en el destino
                
                // Corto delay para ver el pulso y luego limpiar
                setTimeout(() => {
                    dot.classList.remove('flow-dot-visible');
                    dot.classList.remove('dot-pulse');
                    dot.style.transitionDuration = `0ms`;
                    
                    // Restaurar el color del borde de los compartimentos (quitar el acento)
                    resetCompartmentBorders(defaultColor);
                    
                    if(onComplete) onComplete();
                }, 300); // 300ms de pulso visible
                
            }, duration + 50);
        }

        function stopFlowAnimation() {
            clearTimeout(flowSequenceTimeout);
            isAnimating = false;
            document.querySelectorAll('.flow-dot').forEach(dot => {
                dot.classList.remove('flow-dot-visible', 'dot-pulse');
                dot.style.transitionDuration = `0ms`;
            });
            if (models[currentModelNumber]) {
                resetCompartmentBorders(models[currentModelNumber].color);
            }
        }


        function startFlowAnimation(activeSteps) {
            if (isAnimating || activeSteps.length === 0) return; 
            isAnimating = true;

            const model = models[currentModelNumber];
            let stepIndex = 0;

            const nextStep = () => {
                if (stepIndex >= activeSteps.length || !isAnimating) {
                    isAnimating = false;
                    // Si la concentración sigue siendo alta, reiniciar el ciclo de animación
                    if (chartConcentration.C1_conc > 0.01) {
                        startFlowAnimation(activeSteps);
                    }
                    return;
                }

                const step = activeSteps[stepIndex];
                
                const time = myChart.options.plugins.interactionPlugin.currentTime || 0;
                const baseDuration = step.duration;
                let effectiveDuration = baseDuration;

                // Ralentizar la animación a medida que la concentración baja (simulando menor flujo)
                if (time > 5) {
                     effectiveDuration = baseDuration + Math.min(2000, (time - 5) * 150); 
                }
                
                if (!isAnimating) return;
                
                moveDotAlongPath(step.id, step.pathId, step.targets, step.paths, effectiveDuration, model.color, model.accentColor, () => {
                    stepIndex++;
                    flowSequenceTimeout = setTimeout(nextStep, 50);
                });
            };

            nextStep();
        }

        let chartConcentration = { C1_conc: 0 }; // Almacenar la concentración para control de flujo

        function updateDiagramState(t) {
            const model = models[currentModelNumber];
            if (!model) return;
            
            const results = calculateCompartmentAmounts(currentModelNumber, t);
            chartConcentration = results;
            
            updateDiagramFill(results, model.color);
            
            const MIN_CONC_THRESHOLD = 0.01; // Concentración mínima para animar

            if (results.C1_conc > MIN_CONC_THRESHOLD) {
                
                let activeSteps = [];
                
                if (currentModelNumber === 1) {
                    const conc = results.C1_conc;
                    const fullSequence = flowSequences[1];

                    // Lógica solicitada: 10-9: ENTRADA. 9-1: ENTRADA, SALIDA. 1-0: SALIDA.
                    if (conc > 9.0) { // Concentración Alta (10 a 9)
                        // ENTRADA
                        activeSteps = [fullSequence[0]];
                    } else if (conc > 1.0) { // Concentración Media (9 a 1)
                        // ENTRADA y SALIDA
                        activeSteps = fullSequence;
                    } else { // Concentración Baja (1 a 0.01)
                        // SALIDA
                        activeSteps = [fullSequence[1]]; 
                    }
                } else {
                    // Para Modelos 2 y 3, la secuencia de flujo siempre está completa mientras haya droga.
                    activeSteps = flowSequences[currentModelNumber];
                }


                // Lógica de inicio/reinicio de la animación
                if (!isAnimating) {
                    startFlowAnimation(activeSteps);
                } else {
                    // Si ya está animando, detenemos y reiniciamos con la nueva secuencia
                    // Esto asegura que si el usuario se mueve rápido en el gráfico, el flujo se actualice.
                    stopFlowAnimation();
                    startFlowAnimation(activeSteps);
                }
            } else {
                stopFlowAnimation();
            }
        }

        // Función para generar el diagrama SVG (Mantenida)
        function generateModelDiagram(modelNumber, color) {
            const strokeColor = color;
            let svgContent = '';
            
            // Incluimos transition en el estilo base para los rectángulos
            const boxStyle = `fill: white; stroke: ${strokeColor}; stroke-width: 4; rx: 8; ry: 8; transition: fill 0.1s, stroke 0.3s, stroke-width 0.3s;`;
            const textStyle = `font-family: Inter, sans-serif; font-size: 14px; fill: ${strokeColor}; font-weight: bold;`;
            // Quitamos la transición de stroke del path para que highlightCompartments la maneje
            const flowStyle = `fill: none; stroke: ${strokeColor}; stroke-width: 3; marker-end: url(#arrowhead${modelNumber}); transition: stroke 0.3s;`;
            const reverseFlowStyle = `fill: none; stroke: ${strokeColor}; stroke-width: 3; marker-start: url(#arrowhead${modelNumber}); transition: stroke 0.3s;`;
            const dotCommonStyle = `r="5" fill="white" stroke="${strokeColor}" stroke-width="2"`;
            const arrowPadding = 10; 

            const commonElements = `
                <defs>
                    <marker id="arrowhead${modelNumber}" markerWidth="10" markerHeight="7" refX="0" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="${strokeColor}" class="marker-fill" style="transition: fill 0.3s;" />
                    </marker>
                </defs>
            `;

            if (modelNumber === 1) {
                const C1_X = 50, C1_Y = 80, C1_W = 200, C1_H = 140;
                svgContent = `
                    <svg viewBox="0 0 300 300" class="w-full h-full">
                        ${commonElements}
                        <rect x="${C1_X}" y="${C1_Y}" width="${C1_W}" height="${C1_H}" id="comp-1" style="${boxStyle}" />
                        <text x="${C1_X + C1_W / 2}" y="${C1_Y + C1_H / 2}" text-anchor="middle" style="${textStyle}">C1 (Central)</text>
                        <path d="M 150 20 L 150 80" id="path-IV" style="${flowStyle}" />
                        <text x="150" y="15" text-anchor="middle" style="font-size: 14px; fill: ${strokeColor}; font-weight: bold;">ENTRADA (IV)</text>
                        <path d="M 220 220 L 220 280" id="path-E" style="${flowStyle}" />
                        <text x="220" y="295" text-anchor="middle" style="font-size: 14px; fill: ${strokeColor}; font-weight: bold;">SALIDA ($$K_e$$)</text>
                        <circle id="flow-dot-IV" class="flow-dot" cx="150" cy="20" ${dotCommonStyle} />
                        <circle id="flow-dot-E" class="flow-dot" cx="220" cy="220" ${dotCommonStyle} />
                    </svg>
                `;
            } else if (modelNumber === 2) {
                const C1_X = 50, C2_X = 250, C_Y = 100, C_Width = 100, C_Height = 150;
                svgContent = `
                    <svg viewBox="0 0 400 350" class="w-full h-full">
                        ${commonElements}
                        <rect x="${C1_X}" y="${C_Y}" width="${C_Width}" height="${C_Height}" id="comp-1" style="${boxStyle}" />
                        <text x="${C1_X + C_Width / 2}" y="${C_Y + C_Height / 2}" text-anchor="middle" style="${textStyle}">C1 (Central)</text>
                        <rect x="${C2_X}" y="${C_Y}" width="${C_Width}" height="${C_Height}" id="comp-2" style="${boxStyle}" />
                        <text x="${C2_X + C_Width / 2}" y="${C_Y + C_Height / 2}" text-anchor="middle" style="${textStyle}">C2 (Periférico)</text>
                        <path d="M ${C1_X + C_Width / 2} 30 L ${C1_X + C_Width / 2} 100" id="path-IV" style="${flowStyle}" />
                        <text x="${C1_X + C_Width / 2}" y="20" text-anchor="middle" style="font-size: 14px; fill: ${strokeColor}; font-weight: bold;">ENTRADA (IV)</text>
                        <path d="M ${C1_X + C_Width} ${C_Y + 40} L ${C2_X} ${C_Y + 40}" id="path-12" style="${flowStyle}" />
                        <text x="${C1_X + C_Width + arrowPadding}" y="${C_Y + 35}" text-anchor="middle" style="font-size: 12px; fill: ${strokeColor};">k12</text>
                        <path d="M ${C2_X} ${C_Y + C_Height - 40} L ${C1_X + C_Width} ${C_Y + C_Height - 40}" id="path-21" style="${reverseFlowStyle}" />
                        <text x="${C1_X + C_Width + arrowPadding}" y="${C_Y + C_Height - 25}" text-anchor="middle" style="font-size: 12px; fill: ${strokeColor};">k21</text>
                        <path d="M ${C1_X + C_Width - 10} ${C_Y + C_Height} L ${C1_X + C_Width - 10} 320" id="path-E" style="${flowStyle}" />
                        <text x="${C1_X + C_Width - 10}" y="335" text-anchor="middle" style="font-size: 14px; fill: ${strokeColor}; font-weight: bold;">SALIDA ($$K_e$$)</text>
                        <circle id="flow-dot-IV" class="flow-dot" cx="${C1_X + C_Width / 2}" cy="30" ${dotCommonStyle} />
                        <circle id="flow-dot-12" class="flow-dot" cx="${C1_X + C_Width}" cy="${C_Y + 40}" ${dotCommonStyle} />
                        <circle id="flow-dot-21" class="flow-dot" cx="${C2_X}" cy="${C_Y + C_Height - 40}" ${dotCommonStyle} />
                        <circle id="flow-dot-E" class="flow-dot" cx="${C1_X + C_Width - 10}" cy="${C_Y + C_Height}" ${dotCommonStyle} />
                    </svg>
                `;
            } else if (modelNumber === 3) {
                const C_Y = 120, C_Width = 100, C_Height = 70;
                const C1_X = 165, C2_X = 35, C3_X = 295; 
                const flowY_Top = C_Y + 25, flowY_Bottom = C_Y + C_Height - 25; 
                const textY_Top = C_Y + 15, textY_Bottom = C_Y + C_Height + 5;
                const textX_Offset = 15;
                svgContent = `
                    <svg viewBox="0 0 450 350" class="w-full h-full">
                        ${commonElements}
                        <rect x="${C2_X}" y="${C_Y}" width="${C_Width}" height="${C_Height}" id="comp-2" style="${boxStyle}" />
                        <text x="${C2_X + C_Width / 2}" y="${C_Y + C_Height / 2}" text-anchor="middle" style="${textStyle}">C2 (Rápido)</text>
                        <rect x="${C1_X}" y="${C_Y}" width="${C_Width}" height="${C_Height}" id="comp-1" style="${boxStyle}" />
                        <text x="${C1_X + C_Width / 2}" y="${C_Y + C_Height / 2}" text-anchor="middle" style="${textStyle}">C1 (Central)</text>
                        <rect x="${C3_X}" y="${C_Y}" width="${C_Width}" height="${C_Height}" id="comp-3" style="${boxStyle}" />
                        <text x="${C3_X + C_Width / 2}" y="${C_Y + C_Height / 2}" text-anchor="middle" style="${textStyle}">C3 (Lento)</text>
                        <path d="M ${C1_X + C_Width / 2} 30 L ${C1_X + C_Width / 2} ${C_Y}" id="path-IV" style="${flowStyle}" />
                        <text x="${C1_X + C_Width / 2}" y="20" text-anchor="middle" style="font-size: 14px; fill: ${strokeColor}; font-weight: bold;">ENTRADA (IV)</text>
                        <path d="M ${C1_X} ${flowY_Bottom} L ${C2_X + C_Width} ${flowY_Bottom}" id="path-12" style="${reverseFlowStyle}" />
                        <text x="${C2_X + C_Width + textX_Offset}" y="${textY_Bottom}" text-anchor="start" style="font-size: 12px; fill: ${strokeColor};">k12 (Rápido)</text>
                        <path d="M ${C2_X + C_Width} ${flowY_Top} L ${C1_X} ${flowY_Top}" id="path-21" style="${flowStyle}" />
                        <text x="${C2_X + C_Width + textX_Offset}" y="${textY_Top}" text-anchor="start" style="font-size: 12px; fill: ${strokeColor};">k21 (Rápido)</text>
                        <path d="M ${C1_X + C_Width} ${flowY_Top} L ${C3_X} ${flowY_Top}" id="path-13" style="${flowStyle}" />
                        <text x="${C1_X + C_Width + textX_Offset}" y="${textY_Top}" text-anchor="start" style="font-size: 12px; fill: ${strokeColor};">k13 (Lento)</text>
                        <path d="M ${C3_X} ${flowY_Bottom} L ${C1_X + C_Width} ${flowY_Bottom}" id="path-31" style="${reverseFlowStyle}" />
                        <text x="${C1_X + C_Width + textX_Offset}" y="${textY_Bottom}" text-anchor="start" style="font-size: 12px; fill: ${strokeColor};">k31 (Lento)</text>
                        <path d="M ${C1_X + C_Width / 2} ${C_Y + C_Height} L ${C1_X + C_Width / 2} 290" id="path-E" style="${flowStyle}" />
                        <text x="${C1_X + C_Width / 2}" y="310" text-anchor="middle" style="font-size: 14px; fill: ${strokeColor}; font-weight: bold;">SALIDA ($$K_e$$)</text>
                        <circle id="flow-dot-IV" class="flow-dot" cx="${C1_X + C_Width / 2}" cy="30" ${dotCommonStyle} />
                        <circle id="flow-dot-12" class="flow-dot" cx="${C1_X}" cy="${flowY_Bottom}" ${dotCommonStyle} />
                        <circle id="flow-dot-21" class="flow-dot" cx="${C2_X + C_Width}" cy="${flowY_Top}" ${dotCommonStyle} />
                        <circle id="flow-dot-13" class="flow-dot" cx="${C1_X + C_Width}" cy="${flowY_Top}" ${dotCommonStyle} />
                        <circle id="flow-dot-31" class="flow-dot" cx="${C3_X}" cy="${flowY_Bottom}" ${dotCommonStyle} />
                        <circle id="flow-dot-E" class="flow-dot" cx="${C1_X + C_Width / 2}" cy="${C_Y + C_Height}" ${dotCommonStyle} />
                    </svg>
                `;
            }

            return svgContent;
        }


        /**
         * Actualiza el gráfico y la descripción del modelo.
         */
        window.updateChart = function(modelNumber) {
            const model = models[modelNumber];
            if (!model) return;
            
            currentModelNumber = modelNumber;

            // Detener y limpiar cualquier animación de flujo pendiente al cambiar de modelo
            stopFlowAnimation(); 

            if (myChart) {
                myChart.destroy();
            }

            // 1. Renderizar el Diagrama Dinámico
            const diagramElement = document.getElementById('modelDiagramContainer');
            diagramElement.innerHTML = generateModelDiagram(modelNumber, model.color);
            
            // 2. Renderizar la descripción
            const descElement = document.getElementById('modelDescription');
            descElement.innerHTML = model.description;
            if (window.MathJax) {
                MathJax.typeset([diagramElement, descElement]);
            }

            // 3. Activar el botón correcto
            document.querySelectorAll('.model-button').forEach(btn => {
                btn.classList.remove('active-1', 'active-2', 'active-3');
                btn.classList.add('bg-gray-100', 'text-dark-text');
            });
            const activeBtn = document.getElementById(`btn-model-${modelNumber}`);
            if (activeBtn) {
                activeBtn.classList.add(`active-${modelNumber}`);
                activeBtn.classList.remove('bg-gray-100', 'text-dark-text');
            }


            // 4. Crear la nueva instancia del gráfico
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    modelNumber: modelNumber, 
                    datasets: [{
                        label: model.label,
                        data: model.data,
                        borderColor: model.color,
                        backgroundColor: model.color + '40',
                        borderWidth: 4,
                        pointRadius: 0,
                        tension: 0.4,
                        fill: false,
                        stepped: false, 
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        interactionPlugin: {
                            currentTime: null,
                            currentValue: null
                        },
                        legend: { display: true, position: 'top', labels: { font: { size: 14 } } },
                        tooltip: { enabled: true, mode: 'nearest', intersect: false }
                    },
                    hover: { mode: 'nearest', intersect: false, axis: 'x' },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Tiempo (Horas)' },
                            beginAtZero: true,
                            max: MAX_TIME 
                        },
                        y: {
                            title: { display: true, text: 'Concentración en Plasma (Unidades Arbitrarias)' },
                            beginAtZero: true,
                            max: 10 // Establecer el máximo en 10 para coincidir con la lógica 10-9-1-0
                        }
                    }
                }
            });

            // 5. Iniciar el estado del diagrama
            updateDiagramState(0);
        }

        // --- PLUGIN DE CHART.JS PARA DIBUJAR EL PUNTO DE INTERACCIÓN ---
        const interactionPlugin = {
            id: 'interactionPlugin',
            afterEvent: (chart, args) => {
                if (currentView !== 'compartments') return; 

                if (args.event.type !== 'mousemove' && args.event.type !== 'mouseout') return;

                const { x, y } = args.event;
                const chartArea = chart.chartArea;
                
                // Si el mouse sale del área del gráfico o se dispara un mouseout
                if (x < chartArea.left || x > chartArea.right || y < chartArea.top || y > chartArea.bottom || args.event.type === 'mouseout') {
                    stopFlowAnimation(); 
                    chart.options.plugins.interactionPlugin.currentTime = null;
                    chart.draw();
                    // Limpiar el llenado (dejando solo el color base)
                    updateDiagramFill({ C1: 0, C2: 0, C3: 0 }, models[currentModelNumber].color);
                    return;
                }

                // Si el mouse está sobre el gráfico
                const scaleX = chart.scales['x'];
                const time = scaleX.getValueForPixel(x);
                
                const limitedTime = Math.max(0, Math.min(MAX_TIME, time));
                
                const modelFunction = models[chart.data.modelNumber].mainFunction;
                const valueY = modelFunction(limitedTime);
                
                updateDiagramState(limitedTime);
                
                chart.options.plugins.interactionPlugin.currentTime = limitedTime;
                chart.options.plugins.interactionPlugin.currentValue = valueY;
                chart.draw(); 
            },
            afterDraw: (chart) => {
                if (currentView !== 'compartments') return; 

                const { ctx } = chart;
                const currentTime = chart.options.plugins.interactionPlugin.currentTime;
                const currentValue = chart.options.plugins.interactionPlugin.currentValue;

                if (currentTime !== null && currentValue !== null) {
                    const scaleX = chart.scales['x'];
                    const scaleY = chart.scales['y'];

                    const xPos = scaleX.getPixelForValue(currentTime);
                    const yPos = scaleY.getPixelForValue(currentValue);

                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(xPos, yPos, 6, 0, Math.PI * 2); 
                    ctx.fillStyle = models[chart.data.modelNumber].color; 
                    ctx.fill();
                    ctx.restore();
                }
            }
        };
        
        Chart.register(interactionPlugin);


        // === LÓGICA DEL QUIZ (Mantenida) ===
        const CORRECT_ANSWER = 'B';
        let quizCompleted = false;

        function checkAnswer(selectedAnswer) {
            if (quizCompleted || currentView !== 'compartments') return;

            quizCompleted = true;
            const optionsDiv = document.getElementById('quiz-options');
            const feedbackDiv = document.getElementById('quiz-feedback');
            let selectedOption = null;

            optionsDiv.querySelectorAll('.quiz-option').forEach(option => {
                const answer = option.getAttribute('data-answer');
                
                if (answer === selectedAnswer) {
                    selectedOption = option;
                    option.classList.remove('bg-white');
                    option.classList.add('border-primary-blue/50');
                }

                option.onclick = null; 

                if (answer === CORRECT_ANSWER) {
                    option.classList.add('correct');
                }
            });

            feedbackDiv.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'text-red-800', 'text-green-800');
            
            if (selectedAnswer === CORRECT_ANSWER) {
                selectedOption.classList.add('correct');
                feedbackDiv.classList.add('bg-green-100', 'text-green-800');
                feedbackDiv.innerHTML = '<span class="font-bold">¡Respuesta Correcta!</span> La organización jerárquica es una característica clave de los sistemas biológicos complejos, como los representados por los modelos fisiológicos, donde existen múltiples niveles de regulación.';
            } else {
                selectedOption.classList.add('incorrect');
                feedbackDiv.classList.add('bg-red-100', 'text-red-800');
                feedbackDiv.innerHTML = '<span class="font-bold">Respuesta Incorrecta.</span> La respuesta correcta es la B. Los sistemas fisiológicos, a diferencia de los compartimentos matemáticos simples, reflejan una complejidad jerárquica (ej. sistema nervioso > órgano > célula).';
            }
        }


        // =======================================================
        // === LÓGICA DE FLUIDOS CORPORALES ===
        // =======================================================

        function updateFluidCalculations() {
            const weight = parseFloat(document.getElementById('weight-input').value) || 70;
            const fluidPercent = parseFloat(document.getElementById('fluid-percent-slider').value) || 60;
            
            document.getElementById('fluid-percent-value').textContent = fluidPercent;

            const LCT = weight * (fluidPercent / 100);
            
            // Distribución: LIC (2/3 de LCT) y LEC (1/3 de LCT)
            const LIC = LCT * (2/3);
            const LEC = LCT * (1/3);

            // Composición del LEC: Intersticial (80% de LEC) y Plasma (20% de LEC)
            const Interstitial = LEC * 0.8;
            const Plasma = LEC * 0.2;

            // Actualizar display
            document.getElementById('total-fluid-liters').textContent = LCT.toFixed(1);
            document.getElementById('icf-liters').textContent = LIC.toFixed(1) + ' L';
            document.getElementById('ecf-liters').textContent = LEC.toFixed(1) + ' L';
            document.getElementById('plasma-liters').textContent = Plasma.toFixed(1) + ' L';
            document.getElementById('interstitial-liters').textContent = Interstitial.toFixed(1) + ' L';

            // Ya no hay gráficos de pastel para actualizar.
        }

        // =======================================================
        // === LÓGICA DE NAVEGACIÓN ===
        // =======================================================

        window.changeView = function(viewName) {
            currentView = viewName;
            
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.getElementById(`nav-${viewName}`).classList.add('active');

            // Lógica de inicialización/limpieza al cambiar de vista
            if (viewName === 'compartments') {
                // Asegurarse de que el gráfico de compartimentos esté inicializado
                if (!myChart || myChart.data.modelNumber !== currentModelNumber) {
                     updateChart(currentModelNumber);
                }
            } else if (viewName === 'fluids') {
                // Limpiar animación de flujo de compartimentos
                stopFlowAnimation(); 
                updateFluidCalculations();
            }
        }


        // === LÓGICA DEL FOOTER DE MÁQUINA DE ESCRIBIR (Mantenida) ===
        const messages = [
            "¿SABÍAS QUE EL KANJI DE LA PALABRA AGUA ES HERMOSO?",
            "¡SIGUENOS EN INSTAGRAM COMO..."
        ];
        let messageIndex = 0;
        let charIndex = 0;
        const typingSpeed = 75; 
        const delayBetweenMessages = 3000; 

        function typeWriter() {
            const textElement = document.getElementById('typing-text');
            const currentMessage = messages[messageIndex];
            
            if (charIndex < currentMessage.length) {
                textElement.textContent += currentMessage.charAt(charIndex);
                charIndex++;
                setTimeout(typeWriter, typingSpeed);
            } else {
                setTimeout(() => {
                    charIndex = 0;
                    textElement.textContent = '';
                    messageIndex = (messageIndex + 1) % messages.length;
                    setTimeout(typeWriter, typingSpeed / 2);
                }, delayBetweenMessages);
            }
        }

        // --- Inicialización ---
        window.onload = function() {
            // Carga de MathJax para fórmulas
            const mathJaxScript = document.createElement('script');
            mathJaxScript.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
            mathJaxScript.async = true;
            document.head.appendChild(mathJaxScript);

            // Inicializar la vista por defecto (Compartimentos)
            changeView('compartments');
            
            // Configurar Listeners para Fluidos
            document.getElementById('weight-input').addEventListener('input', updateFluidCalculations);
            document.getElementById('fluid-percent-slider').addEventListener('input', updateFluidCalculations);
            
            // Iniciar la animación del footer
            typeWriter();
        };
    </script>
</body>
</html>
